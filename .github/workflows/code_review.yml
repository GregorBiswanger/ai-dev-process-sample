name: OpenAI Code Review on Pull Request

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  review_code:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Send code to OpenAI for review
      id: openai_review
      run: |
        set -euo pipefail

        git fetch origin
        CODE_DIFF=$(git diff ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} --unified=0)

        # Optional: Wenn kein Diff, direkt freigeben
        if [ -z "$CODE_DIFF" ]; then
          REVIEW_MESSAGE="Ich gebe den PR frei."
          echo "REVIEW_MESSAGE=$REVIEW_MESSAGE" >> $GITHUB_ENV
          exit 0
        fi

        REVIEW_RESPONSE=$(
          jq -n \
            --arg content "$CODE_DIFF" \
            '{
              "model": "gpt-4.1-mini",
              "messages": [
                {
                  "role": "system",
                  "content": "Du bist Developer Security Experte und Developer Performance Experte. Analysiere den geänderten Sourcecode. Beschreibe ausführlich, was für Probleme du finden konntest die deine Schwerpunkte betreffen. Zeige zusätzlich einen Lösungsweg. Wenn du keine Probleme oder Auffälligkeiten gefunden hast, antworte ausschließlich exakt mit dem Text: Ich gebe den PR frei. Bei keinen ernsthaften Problemen, füge am Ende von deiner Antwort den exakt den Text: Ich gebe den PR frei. Wenn ernsthafte schwierigkeiten entdeckt wurden, schreibe auf keinen Fall den Text: Ich gebe den PR frei. Antworte im Format GitHub Flavored Markdown (GFM) und halte die Antwort kurz. Antworte im Format GitHub Flavored Markdown (GFM), aber schließe deine Antwort nicht in einen Codeblock ein."
                },
                {
                  "role": "user",
                  "content": $content
                }
              ],
              "temperature": 1,
              "max_tokens": 4096,
              "top_p": 1,
              "frequency_penalty": 0,
              "presence_penalty": 0
            }' |
          curl -sS https://api.openai.com/v1/chat/completions \
               -H "Content-Type: application/json" \
               -H "Authorization: Bearer ${{ secrets.OPENAI_API_KEY }}" \
               -d @-
        )

        echo "Raw OpenAI response:"
        echo "$REVIEW_RESPONSE"

        # Fehlernachricht extrahieren, falls vorhanden
        ERROR_MESSAGE=$(echo "$REVIEW_RESPONSE" | jq -r '.error.message // empty')

        if [ -n "$ERROR_MESSAGE" ]; then
          REVIEW_MESSAGE="OpenAI API Fehler: $ERROR_MESSAGE"
        else
          # content extrahieren, null vermeiden
          REVIEW_MESSAGE=$(echo "$REVIEW_RESPONSE" | jq -r '.choices[0].message.content // empty')
        fi

        # Fallback, wenn content leer oder "null"
        if [ -z "$REVIEW_MESSAGE" ] || [ "$REVIEW_MESSAGE" = "null" ]; then
          REVIEW_MESSAGE="Es gab ein Problem bei der Überprüfung des Codes durch OpenAI. Bitte überprüfe manuell."
        fi

        # Für Env neue Zeilen escapen
        REVIEW_MESSAGE_ESCAPED=$(printf '%s' "$REVIEW_MESSAGE" | sed ':a;N;$!ba;s/\n/__NEWLINE__/g')
        echo "REVIEW_MESSAGE=$REVIEW_MESSAGE_ESCAPED" >> "$GITHUB_ENV"

    - name: Comment on PR with OpenAI's review
      uses: actions/github-script@v3
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const prNumber = ${{ github.event.pull_request.number }};
          let reviewMessage = process.env.REVIEW_MESSAGE;
          reviewMessage = reviewMessage.split('__NEWLINE__').join('\n');
          github.issues.createComment({
            issue_number: prNumber,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: reviewMessage
          });
          
    - name: Assign PR to GregorBiswanger if review is positive
      if: contains(env.REVIEW_MESSAGE, 'Ich gebe den PR frei')
      uses: actions/github-script@v3
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const prNumber = ${{ github.event.pull_request.number }};
          github.issues.addAssignees({
            issue_number: prNumber,
            owner: context.repo.owner,
            repo: context.repo.repo,
            assignees: ['GregorBiswanger']
          });
    
    - name: Fail if review is not positive
      if: ${{ !contains(env.REVIEW_MESSAGE, 'Ich gebe den PR frei') }}
      run: |
        echo "Review nicht bestanden. Der Merge des Pull Requests wird verhindert."
        exit 1
